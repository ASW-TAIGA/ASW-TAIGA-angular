<div class="min-h-screen bg-gray-100">

  <app-issue-form
    *ngIf="showNewIssueForm && issueOptionsForForm"
    [statusOptions]="issueOptionsForForm.statusOptions"
    [typeOptions]="issueOptionsForForm.typeOptions"
    [severityOptions]="issueOptionsForForm.severityOptions"
    [priorityOptions]="issueOptionsForForm.priorityOptions"
    [projectUsers]="allProjectUsers" [currentUser]="currentUser"     (closeForm)="toggleNewIssueForm()"
    (issueCreated)="handleIssueCreated($event)">
  </app-issue-form>

  <div *ngIf="!showNewIssueForm" class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <header class="mb-6 flex justify-between items-center">
      <h1 class="text-3xl font-bold text-gray-900">Issues</h1>
      <button
        type="button"
        (click)="toggleNewIssueForm()"
        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
        New Issue
      </button>
    </header>

    <div *ngIf="isLoading" class="text-center py-10">
      <p class="text-gray-500">Loading issues...</p>
    </div>

    <div *ngIf="!isLoading && issues.length > 0" class="bg-white shadow overflow-hidden sm:rounded-md">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
        <tr>
          <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            <button (click)="sortBy('issue_type')" class="flex items-center justify-center w-full group focus:outline-none">
              <span>Type</span>
              <span class="ml-1 text-gray-400 group-hover:text-gray-600 transition-colors">
                <svg *ngIf="currentSortColumn !== 'issue_type'" class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></svg>
                <svg *ngIf="currentSortColumn === 'issue_type' && sortDirection === 'asc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>
                <svg *ngIf="currentSortColumn === 'issue_type' && sortDirection === 'desc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
              </span>
            </button>
          </th>
          <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            <button (click)="sortBy('severity')" class="flex items-center justify-center w-full group focus:outline-none">
              <span>Severity</span>
              <span class="ml-1 text-gray-400 group-hover:text-gray-600 transition-colors">
                  <svg *ngIf="currentSortColumn !== 'severity'" class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></svg>
                  <svg *ngIf="currentSortColumn === 'severity' && sortDirection === 'asc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>
                  <svg *ngIf="currentSortColumn === 'severity' && sortDirection === 'desc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                </span>
            </button>
          </th>
          <th scope="col" class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            <button (click)="sortBy('priority')" class="flex items-center justify-center w-full group focus:outline-none">
              <span>Priority</span>
              <span class="ml-1 text-gray-400 group-hover:text-gray-600 transition-colors">
                  <svg *ngIf="currentSortColumn !== 'priority'" class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></svg>
                  <svg *ngIf="currentSortColumn === 'priority' && sortDirection === 'asc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>
                  <svg *ngIf="currentSortColumn === 'priority' && sortDirection === 'desc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                </span>
            </button>
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Issue</th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <button (click)="sortBy('status')" class="flex items-center group focus:outline-none">
              <span>Status</span>
              <span class="ml-1 text-gray-400 group-hover:text-gray-600 transition-colors">
                  <svg *ngIf="currentSortColumn !== 'status'" class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15 12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" /></svg>
                  <svg *ngIf="currentSortColumn === 'status' && sortDirection === 'asc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m4.5 15.75 7.5-7.5 7.5 7.5" /></svg>
                  <svg *ngIf="currentSortColumn === 'status' && sortDirection === 'desc'" class="w-3 h-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" /></svg>
                </span>
            </button>
          </th>
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Modified</th>
          <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Assignee</th>
        </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
        <tr *ngFor="let issue of issues" (click)="selectIssueAndNavigate(issue)" class="hover:bg-gray-50 cursor-pointer">
          <td class="px-3 py-4 whitespace-nowrap text-center">
            <span class="h-3 w-3 rounded-full inline-block" [ngClass]="issue.issue_type.color" [title]="issue.issue_type.name"></span>
          </td>
          <td class="px-3 py-4 whitespace-nowrap text-center">
            <span class="h-3 w-3 rounded-full inline-block" [ngClass]="issue.severity.color" [title]="issue.severity.name"></span>
          </td>
          <td class="px-3 py-4 whitespace-nowrap text-center">
            <span class="h-3 w-3 rounded-full inline-block" [ngClass]="issue.priority.color" [title]="issue.priority.name"></span>
          </td>
          <td class="px-6 py-4">
            <div class="text-sm font-medium text-indigo-600 hover:text-indigo-900">#{{issue.id}} {{ issue.title }}</div>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                  [ngClass]="issue.status.is_closed ? 'bg-gray-200 text-gray-700' : (issue.status.color && issue.status.color.startsWith('bg-') ? issue.status.color.replace('bg-','bg-opacity-20 text-') : 'bg-blue-100 text-blue-800')">
              {{ issue.status.name }}
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            {{ issue.updated_at | date:'dd MMM yy' }}
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">
            <div class="relative inline-flex items-center">
              <button
                type="button"
                id="options-menu-assignee-{{issue.id}}"
                class="assignee-dropdown-trigger flex items-center focus:outline-none"
                (click)="toggleAssigneeDropdown(issue.id, $event)"
                [title]="issue.assignee ? 'Change assignee: ' + issue.assignee.username : 'Assign user'">
                <div *ngIf="issue.assignee" class="flex items-center">
                  <img *ngIf="issue.assignee.avatar_url" [src]="issue.assignee.avatar_url" alt="{{issue.assignee.username}}" class="h-6 w-6 rounded-full">
                  <div *ngIf="!issue.assignee.avatar_url" class="h-6 w-6 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs font-semibold">
                    {{ issue.assignee.first_name ? issue.assignee.first_name[0].toUpperCase() : '' }}{{ issue.assignee.last_name ? issue.assignee.last_name[0].toUpperCase() : '' }}
                  </div>
                </div>
                <div *ngIf="!issue.assignee" class="h-6 w-6 rounded-full border-2 border-dashed border-gray-300 flex items-center justify-center text-gray-400 text-xs">
                  ?
                </div>
                <svg class="w-4 h-4 ml-1 text-gray-400 group-hover:text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>

              <div *ngIf="activeAssigneeDropdownForIssueId === issue.id"
                   class="assignee-dropdown-menu origin-top-right absolute right-0 mt-2 w-64 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20 max-h-60 overflow-y-auto">
                <div class="py-1"
                     role="menu"
                     aria-orientation="vertical"
                     [attr.aria-labelledby]="'options-menu-assignee-' + issue.id">

                  <a (click)="changeAssignee(issue, null, $event); $event.stopPropagation()"
                     class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 cursor-pointer"
                     [class.bg-gray-100]="!issue.assignee"
                     role="menuitem">
                    <span class="w-6 h-6 mr-2 border-2 border-dashed rounded-full flex items-center justify-center text-gray-400 text-xs">?</span>
                    Unassigned
                  </a>
                  <a *ngFor="let user of allProjectUsers" (click)="changeAssignee(issue, user, $event); $event.stopPropagation()"
                     class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900 cursor-pointer"
                     [class.bg-gray-100]="issue.assignee?.id === user.id"
                     role="menuitem">
                    <img *ngIf="user.avatar_url" [src]="user.avatar_url" alt="{{user.username}}" class="w-6 h-6 rounded-full mr-2">
                    <div *ngIf="!user.avatar_url" class="w-6 h-6 rounded-full bg-gray-300 flex items-center justify-center text-white text-xs mr-2 font-semibold">
                      {{ user.first_name ? user.first_name[0].toUpperCase() : '' }}{{ user.last_name ? user.last_name[0].toUpperCase() : '' }}
                    </div>
                    <span class="truncate">{{user.first_name}} {{user.last_name}} ({{user.username}})</span>
                  </a>
                </div>
              </div>
            </div>
          </td>
        </tr>
        </tbody>
      </table>
    </div>
    <ng-template #noIssuesFound>
      <div class="text-center py-12">
        <h3 class="mt-2 text-sm font-medium text-gray-900">No issues found.</h3>
        <p class="mt-1 text-sm text-gray-500">Perhaps try different filters or create a new issue.</p>
      </div>
    </ng-template>
  </div>
</div>
